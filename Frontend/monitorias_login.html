<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitorías Académicas - UdeM</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .loading-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
    }

    .status-card {
      max-width: 420px;
      margin: 60px auto;
      padding: 30px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .status-card h1 {
      margin-bottom: 10px;
      color: #8B0000;
      font-size: 26px;
    }

    .status-card p {
      margin: 6px 0;
      color: #444;
      font-size: 15px;
    }

    .loader {
      margin: 24px auto 8px;
      border: 6px solid #f1f1f1;
      border-top: 6px solid #8B0000;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-card button {
      margin-top: 18px;
      padding: 10px 22px;
      border: none;
      border-radius: 6px;
      background: #8B0000;
      color: #ffffff;
      font-weight: bold;
      cursor: pointer;
      display: none;
    }

    .status-card button:hover {
      background: #a50000;
    }

    .status-error {
      margin-top: 16px;
      padding: 12px;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      border-radius: 6px;
      display: none;
    }
  </style>
</head>
<body class="loading-page">
  <header class="header">
    <span class="mini-text-vertical">MinEducación</span>
    <img src="logo.png" alt="Logo UdeM" class="logo" />
  </header>

  <main class="status-card">
    <h1 id="statusTitle">Validando sesión</h1>
    <p id="statusMessage">Por favor espera mientras verificamos tu acceso...</p>
    <div id="loadingSpinner" class="loader"></div>
    <p id="statusHint">Detectando rol y preparando tu panel de monitorías.</p>
    <div id="statusError" class="status-error"></div>
    <button id="loginButton">Ir al inicio de sesión</button>
  </main>

  <script src="api.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const statusTitle = document.getElementById('statusTitle');
      const statusMessage = document.getElementById('statusMessage');
      const statusHint = document.getElementById('statusHint');
      const statusError = document.getElementById('statusError');
      const loginButton = document.getElementById('loginButton');
      const loadingSpinner = document.getElementById('loadingSpinner');

      const showAuthError = (message) => {
        loadingSpinner.style.display = 'none';
        statusTitle.textContent = 'Sesión no encontrada';
        statusMessage.textContent = 'Tu sesión no está activa en este navegador.';
        statusHint.textContent = 'Inicia sesión nuevamente para acceder al módulo de monitorías.';
        statusError.textContent = message;
        statusError.style.display = 'block';
        loginButton.style.display = 'inline-block';
      };

      const resolveDestination = (rol) => {
        if (rol === 'COORDINATOR' || rol === 'PROFESSOR') {
          return 'monitorias.html';
        }
        return 'monitorias.html';
      };

      loginButton.addEventListener('click', () => {
        window.location.href = 'index.html';
      });

      try {
        const authenticated = ApiUtils.isAuthenticated();
        if (!authenticated) {
          throw new Error('NO_AUTH');
        }

        await apiClient.detectServer();

        let userData = ApiUtils.getUserData();
        if (!userData) {
          try {
            userData = await apiClient.getProfile();
            if (userData) {
              localStorage.setItem('user_data', JSON.stringify(userData));
              if (userData.rol) {
                localStorage.setItem('user_rol', userData.rol);
              }
            }
          } catch (fetchError) {
            console.warn('No se pudo refrescar el perfil del usuario:', fetchError.message);
          }
        }

        const rol = ApiUtils.getUserRole();
        const destino = resolveDestination(rol);

        statusTitle.textContent = '¡Bienvenido!';
        statusMessage.textContent = userData && userData.nombre
          ? `Hola ${userData.nombre}, estamos preparando tu panel.`
          : 'Sesión detectada. Redirigiendo al panel de monitorías...';
        statusHint.textContent = rol ? `Rol detectado: ${rol}` : 'Rol pendiente de sincronizar.';

        setTimeout(() => {
          window.location.href = destino;
        }, 600);
      } catch (error) {
        if (error.message === 'NO_AUTH') {
          showAuthError('No encontramos un token activo.');
        } else {
          console.error('Error al preparar el módulo de monitorías:', error);
          showAuthError('Ocurrió un problema al validar tu sesión.');
        }
      }
    });
  </script>
</body>
</html>
